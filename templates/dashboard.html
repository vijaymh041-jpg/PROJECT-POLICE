{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>All Incidents - Davanagere Police</h2>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="location.reload()">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
        <button class="btn btn-police" onclick="showAddIncidentModal()">
            <i class="fas fa-plus me-1"></i> New Incident
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="card card-police stats-card">
            <i class="fas fa-list"></i>
            <h3 id="totalIncidents">{{ total_incidents }}</h3>
            <p>Total Incidents</p>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card card-police stats-card">
            <i class="fas fa-shield-alt"></i>
            <h3 id="policeCount">{{ police_count }}</h3>
            <p>Police Reports</p>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card card-police stats-card">
            <i class="fas fa-users"></i>
            <h3 id="publicCount">{{ public_count }}</h3>
            <p>Public Reports</p>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card card-police stats-card">
            <i class="fas fa-exclamation-triangle"></i>
            <h3 id="highSeverityCount">{{ high_severity_count }}</h3>
            <p>High Severity</p>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card card-police stats-card assigned-stats">
            <i class="fas fa-user-check"></i>
            <h3 id="assignedCount">{{ assigned_count }}</h3>
            <p>Assigned</p>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card card-police stats-card unassigned-stats">
            <i class="fas fa-user-times"></i>
            <h3 id="unassignedCount">{{ unassigned_count }}</h3>
            <p>Unassigned</p>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card card-police">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Filter by assignment:</small>
                        <div class="btn-group btn-group-sm ms-2">
                            <button type="button" class="btn btn-outline-primary active" onclick="filterByAssignment('all')">
                                All Cases
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="filterByAssignment('assigned')">
                                <i class="fas fa-user-check me-1"></i>Assigned
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="filterByAssignment('unassigned')">
                                <i class="fas fa-user-times me-1"></i>Unassigned
                            </button>
                        </div>
                    </div>
                    <div>
                        <small class="text-muted">
                            Showing <span id="visibleCount">{{ total_incidents }}</span> of {{ total_incidents }} incidents
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card card-police">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Incident Records (Both Collections)</h5>
        <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control" placeholder="Search incidents..." id="searchInput">
            <button class="btn btn-outline-secondary" type="button" onclick="searchIncidents()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0" id="incidentsTable">
                <thead class="table-light">
                    <tr>
                        <th>Assignment</th>
                        <th>Source</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Location</th>
                        <th>Assigned Officer</th>
                        <th>Reported</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for incident in all_incidents %}
                    <tr class="incident-row {% if not incident.is_assigned %}unassigned-incident{% else %}assigned-incident{% endif %}" 
                        data-incident-id="{{ incident._id }}" 
                        data-latitude="{{ incident.latitude }}" 
                        data-longitude="{{ incident.longitude }}"
                        data-title="{{ incident.title }}"
                        data-address="{{ incident.address }}"
                        data-source="{{ incident.source }}"
                        data-is-assigned="{{ incident.is_assigned }}">
                        <td class="assignment-status">
                            {% if incident.is_assigned %}
                            <span class="badge bg-success assigned-badge">
                                <i class="fas fa-user-check me-1"></i>Assigned
                            </span>
                            {% else %}
                            <span class="badge bg-danger unassigned-badge">
                                <i class="fas fa-user-times me-1"></i>Unassigned
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if incident.source == 'police' %}
                            <span class="badge bg-primary">
                                <i class="fas fa-shield-alt me-1"></i>Police
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-user me-1"></i>Public
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-bold">{{ incident.title|default('No Title', true) }}</div>
                            <small class="text-muted">
                                {% if incident.description %}
                                    {{ incident.description[:50] }}...
                                {% else %}
                                    No description available
                                {% endif %}
                            </small>
                        </td>
                        <td>{{ incident.incident_type|default('Unknown', true) }}</td>
                        <td>
                            <span class="badge bg-{{ 'danger' if incident.severity == 'high' else 'warning' if incident.severity == 'medium' else 'success' }}">
                                {{ incident.severity|default('medium', true)|title }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'primary' if incident.status == 'active' else 'success' if incident.status == 'resolved' else 'secondary' }}">
                                {{ incident.status|default('pending', true)|title }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center" title="{{ incident.address }}">
                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                <span>{{ incident.address[:20] }}...</span>
                            </div>
                        </td>
                        <td>
                            {% if incident.assigned_officer and incident.assigned_officer != 'Unassigned' %}
                            <span class="badge bg-info text-dark">
                                <i class="fas fa-user me-1"></i>{{ incident.assigned_officer }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-user-slash me-1"></i>Unassigned
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if incident.created_at %}
                            <small>{{ incident.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            {% else %}
                            <small class="text-muted">Unknown</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary get-directions-btn" title="Get Directions">
                                    <i class="fas fa-directions"></i>
                                </button>
                                {% if incident.source == 'police' and current_user.username == incident.reported_by %}
                                <button class="btn btn-outline-warning edit-incident-btn" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-success assign-officer-btn" title="Assign Officer">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                <button class="btn btn-outline-info view-details-btn" title="Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <h5>No Incidents Found</h5>
                            <p>No incidents have been reported in either collection.</p>
                            <button class="btn btn-police mt-2" onclick="showAddIncidentModal()">
                                <i class="fas fa-plus me-2"></i>Report First Incident
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
                Showing <strong>{{ total_incidents }}</strong> incident(s) from both collections
            </small>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card card-police h-100">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('export_csv') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download me-2"></i>Export to CSV
                    </a>
                    <button class="btn btn-outline-success btn-sm" onclick="printReport()">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                    <a href="{{ url_for('reports') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-chart-bar me-2"></i>Generate Analytics
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card card-police h-100">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Incident Distribution</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border rounded p-3 mb-2">
                            <div class="text-primary fw-bold fs-4">{{ police_count }}</div>
                            <small class="text-muted">Police Reports</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3 mb-2">
                            <div class="text-secondary fw-bold fs-4">{{ public_count }}</div>
                            <small class="text-muted">Public Reports</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3 mb-2">
                            <div class="text-success fw-bold fs-4">{{ assigned_count }}</div>
                            <small class="text-muted">Assigned</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3 mb-2">
                            <div class="text-danger fw-bold fs-4">{{ unassigned_count }}</div>
                            <small class="text-muted">Unassigned</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'incidents_modals.html' ignore missing %} 
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// IMPORTANT: Clean JS logic to prevent "stuck" screen
// 1. We use data attributes, not template variables in JS
// 2. We attach listeners after DOM load

document.addEventListener('DOMContentLoaded', function() {
    // Re-attach event listeners for action buttons
    attachEventListeners();
});

// Robust Filter Function
function filterByAssignment(status) {
    const tbody = document.querySelector('#incidentsTable tbody');
    const allIncidentRows = tbody.querySelectorAll('tr.incident-row'); 
    let visibleCount = 0;

    // Update buttons
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    if (event && event.target) event.target.classList.add('active');

    allIncidentRows.forEach(row => {
        // Safe check for string 'True'/'False' from Python
        const isAssigned = (row.dataset.isAssigned === 'True' || row.dataset.isAssigned === 'true');
        let shouldShow = false;

        if (status === 'all') shouldShow = true;
        else if (status === 'assigned') shouldShow = isAssigned;
        else if (status === 'unassigned') shouldShow = !isAssigned;

        row.style.display = shouldShow ? '' : 'none';
        if(shouldShow) visibleCount++;
    });

    // Update count display
    const countSpan = document.getElementById('visibleCount');
    if(countSpan) countSpan.textContent = visibleCount;
}

// Function to handle ALL button clicks safely
function attachEventListeners() {
    // Directions
    document.querySelectorAll('.get-directions-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const row = e.target.closest('tr');
            if(row) {
                const lat = row.dataset.latitude;
                const lng = row.dataset.longitude;
                // Add Google Maps logic here if needed
                alert(`Getting directions for location: ${lat}, ${lng}`);
            }
        });
    });
    
    // Assign Officer
    document.querySelectorAll('.assign-officer-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const row = e.target.closest('tr');
            if(row) {
                // Call your existing showAssignOfficerModal logic
                // Ensure that function exists in your main JS block
                if(typeof showAssignOfficerModal === 'function') {
                    showAssignOfficerModal(row.dataset.incidentId, row.dataset.source);
                }
            }
        });
    });

    // View Details
    document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const row = e.target.closest('tr');
            if(row && typeof viewDetails === 'function') {
                viewDetails(row.dataset.incidentId, row.dataset.source);
            }
        });
    });
}

// Include other necessary JS functions (viewDetails, showAssignOfficerModal, etc.) here
// from your previous working code
</script>
{% endblock %}