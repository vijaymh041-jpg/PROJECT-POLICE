{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">Dashboard - Davanagere</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
        <button class="btn btn-police" onclick="showAddIncidentModal()">
            <i class="fas fa-plus me-1"></i> Report Incident
        </button>
        <button class="btn btn-success" onclick="showAddOfficerModal()">
            <i class="fas fa-user-plus me-1"></i> Add Officer
        </button>
    </div>
</div>

<div class="row row-cols-2 row-cols-md-3 row-cols-xl-6 g-3 mb-4">
    <div class="col">
        <div class="card stats-card h-100 border-start border-4 border-primary shadow-sm">
            <div class="card-body d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-list fa-2x text-primary mb-2"></i>
                <h3 class="fw-bold mb-0" id="totalIncidents">{{ total_incidents }}</h3>
                <small class="text-muted fw-bold">Total</small>
            </div>
        </div>
    </div>
    
    <div class="col">
        <div class="card stats-card h-100 border-start border-4 border-info shadow-sm">
            <div class="card-body d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-shield-alt fa-2x text-info mb-2"></i>
                <h3 class="fw-bold mb-0" id="policeCount">{{ police_count }}</h3>
                <small class="text-muted fw-bold">Police</small>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card stats-card h-100 border-start border-4 border-secondary shadow-sm">
            <div class="card-body d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-users fa-2x text-secondary mb-2"></i>
                <h3 class="fw-bold mb-0" id="publicCount">{{ public_count }}</h3>
                <small class="text-muted fw-bold">Public</small>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card stats-card h-100 border-start border-4 border-warning shadow-sm">
            <div class="card-body d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                <h3 class="fw-bold mb-0">{{ high_severity_count }}</h3>
                <small class="text-muted fw-bold">High Sev</small>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card stats-card h-100 border-start border-4 border-success shadow-sm">
            <div class="card-body d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-user-check fa-2x text-success mb-2"></i>
                <h3 class="fw-bold mb-0">{{ assigned_count }}</h3>
                <small class="text-muted fw-bold">Assigned</small>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card stats-card h-100 border-start border-4 border-danger shadow-sm">
            <div class="card-body d-flex flex-column align-items-center justify-content-center py-3">
                <i class="fas fa-user-times fa-2x text-danger mb-2"></i>
                <h3 class="fw-bold mb-0">{{ unassigned_count }}</h3>
                <small class="text-muted fw-bold">Unassigned</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card card-police h-100 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-stream me-2"></i>Recent Activity</h5>
                <div class="input-group input-group-sm" style="width: 200px;">
                    <input type="text" class="form-control" placeholder="Search..." id="searchInput" onkeyup="searchIncidents()">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
            </div>
            <div class="card-body p-0" style="height: 450px; overflow-y: auto;">
                <div class="list-group list-group-flush" id="incidentsList">
                    {% for incident in incidents %}
                    <div class="list-group-item list-group-item-action incident-item p-3 border-bottom" 
                         style="cursor: pointer;"
                         data-lat="{{ incident.latitude }}" 
                         data-lng="{{ incident.longitude }}"
                         onclick="panToIncident(this)">
                        
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div>
                                <h6 class="mb-0 fw-bold">{{ incident.title }}</h6>
                                <div class="small text-muted mt-1">
                                    <i class="fas fa-map-marker-alt text-danger me-1"></i>{{ incident.address[:40] }}...
                                </div>
                            </div>
                            <span class="badge bg-{{ 'danger' if incident.severity == 'high' else 'warning' if incident.severity == 'medium' else 'success' }} rounded-pill">
                                {{ incident.severity|title }}
                            </span>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">
                                {% if incident.source == 'police' %}
                                    <i class="fas fa-shield-alt text-primary"></i> Police
                                {% else %}
                                    <i class="fas fa-user text-secondary"></i> Public
                                {% endif %}
                                &bull; {{ incident.created_at.strftime('%H:%M') }}
                            </small>
                            
                            {% if incident.is_assigned %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success px-2">Assigned</span>
                            {% else %}
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-2">Unassigned</span>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted p-5">
                        <i class="fas fa-inbox fa-3x mb-3 text-secondary"></i>
                        <p class="mb-0">No recent incidents found.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer text-center bg-transparent border-top-0 pb-3">
                <a href="{{ url_for('incidents') }}" class="btn btn-outline-primary w-100">View Full Incident History</a>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card card-police h-100 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-map-marked-alt me-2"></i>Live Map</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshMap()">
                    <i class="fas fa-compress me-1"></i> Reset View
                </button>
            </div>
            <div class="card-body p-0 position-relative">
                <div id="map" class="map-container" style="min-height: 500px; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addIncidentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Report New Incident</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addIncidentForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="incident_type">
                                <option>Theft</option>
                                <option>Accident</option>
                                <option>Public Disturbance</option>
                                <option>Traffic Violation</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label d-flex justify-content-between align-items-center">
                                Select Location
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="getCurrentLocation()">
                                    <i class="fas fa-location-arrow me-1"></i> Use Current Location
                                </button>
                            </label>
                            <div id="locationMap" style="height: 250px; width: 100%; border-radius: 4px; border: 1px solid #dee2e6;"></div>
                            <small class="text-muted">Click on the map to manually set the location.</small>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Severity</label>
                            <select class="form-select" name="severity">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Latitude</label>
                            <input type="number" step="any" class="form-control" name="latitude" id="inputLat" value="14.4644">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Longitude</label>
                            <input type="number" step="any" class="form-control" name="longitude" id="inputLng" value="75.9218">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-police" onclick="submitNewIncident()">Submit Report</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addOfficerModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Add New Officer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="officerForm">
                    <div class="mb-3">
                        <label class="form-label">Full Name *</label>
                        <input type="text" name="full_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Badge Number *</label>
                        <input type="text" name="badge_number" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Designation *</label>
                        <select name="designation" class="form-select" required>
                            <option value="Police Officer">Police Officer</option>
                            <option value="Inspector">Inspector</option>
                            <option value="Sub-Inspector">Sub-Inspector</option>
                            <option value="ACP">ACP</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitOfficer()">Add Officer</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let map;
    let markers = [];
    let locationMap;
    let locationMarker;

    // --- FIX FOR STUCK SCREEN ---
    function cleanupModals() {
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';
    }

    document.addEventListener('DOMContentLoaded', function() {
        cleanupModals(); 
        initializeMap();
    });

    // --- INCIDENT LOGIC ---
    function showAddIncidentModal() {
        cleanupModals();
        const modal = new bootstrap.Modal(document.getElementById('addIncidentModal'));
        modal.show();
        
        // Initialize location map
        const modalEl = document.getElementById('addIncidentModal');
        modalEl.addEventListener('shown.bs.modal', function () {
            initializeLocationMap();
        }, { once: true });
    }

    function initializeLocationMap() {
        if (!locationMap) {
            locationMap = L.map('locationMap').setView([14.4644, 75.9218], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(locationMap);

            locationMap.on('click', function(e) {
                updateLocationInputs(e.latlng.lat, e.latlng.lng);
            });
        } else {
            setTimeout(() => { locationMap.invalidateSize(); }, 100);
        }
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                updateLocationInputs(lat, lng);
                if(locationMap) locationMap.setView([lat, lng], 16);
            }, () => {
                alert("Location access denied or unavailable.");
            });
        } else {
            alert("Geolocation not supported.");
        }
    }

    function updateLocationInputs(lat, lng) {
        document.getElementById('inputLat').value = lat.toFixed(6);
        document.getElementById('inputLng').value = lng.toFixed(6);
        
        if (locationMarker) locationMap.removeLayer(locationMarker);
        locationMarker = L.marker([lat, lng]).addTo(locationMap);
    }

    function submitNewIncident() {
        const form = document.getElementById('addIncidentForm');
        const data = Object.fromEntries(new FormData(form).entries());
        
        fetch('/api/incidents', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(() => {
            alert('Incident Reported!');
            location.reload();
        })
        .catch(err => alert('Error reporting incident'));
    }

    function searchIncidents() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.incident-item');
        items.forEach(item => {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(term) ? '' : 'none';
        });
    }

    // --- OFFICER LOGIC ---
    function showAddOfficerModal() {
        cleanupModals();
        new bootstrap.Modal(document.getElementById('addOfficerModal')).show();
    }

    function submitOfficer() {
        const form = document.getElementById('officerForm');
        const data = Object.fromEntries(new FormData(form).entries());
        const btn = document.querySelector('#addOfficerModal .btn-success');

        if(!data.full_name || !data.badge_number) return alert("Fill all fields");

        btn.disabled = true;
        btn.innerText = "Adding...";

        fetch('/api/police-officers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(result => {
            if(result.error) alert(result.error);
            else {
                alert("Officer Added!");
                location.reload();
            }
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = "Add Officer";
        });
    }

    // --- MAIN MAP LOGIC ---
    function initializeMap() {
        if (document.getElementById('map')) {
            map = L.map('map').setView([14.4644, 75.9218], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            setTimeout(() => { map.invalidateSize(); }, 500);
            loadIncidentsOnMap();
        }
    }

    function loadIncidentsOnMap() {
        if(!map) return;
        fetch('/api/incidents')
            .then(res => res.json())
            .then(data => {
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                data.forEach(inc => {
                    if (inc.latitude && inc.longitude) {
                        const marker = L.marker([inc.latitude, inc.longitude])
                            .addTo(map)
                            .bindPopup(`<b>${inc.title}</b><br>${inc.address}`);
                        markers.push(marker);
                    }
                });
            });
    }

    function panToIncident(element) {
        const lat = element.getAttribute('data-lat');
        const lng = element.getAttribute('data-lng');
        if (map && lat && lng) {
            map.flyTo([lat, lng], 16);
            document.getElementById('map').scrollIntoView({behavior: "smooth", block: "center"});
        }
    }

    function refreshMap() { 
        if(map) {
            map.setView([14.4644, 75.9218], 13);
            loadIncidentsOnMap();
        }
    }
</script>
{% endblock %}