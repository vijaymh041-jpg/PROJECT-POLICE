{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">All Incidents - Davanagere Police</h2>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="location.reload()">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
        <button class="btn btn-police" onclick="showAddIncidentModal()">
            <i class="fas fa-plus me-1"></i> New Incident
        </button>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-lg-2">
        <div class="card stats-card h-100">
            <div class="card-body text-center p-2">
                <i class="fas fa-list fa-2x text-primary mb-2"></i>
                <h3 class="fw-bold mb-0" id="totalIncidents">{{ total_incidents }}</h3>
                <small class="text-muted fw-bold">Total</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="card stats-card h-100">
            <div class="card-body text-center p-2">
                <i class="fas fa-shield-alt fa-2x text-info mb-2"></i>
                <h3 class="fw-bold mb-0" id="policeCount">{{ police_count }}</h3>
                <small class="text-muted fw-bold">Police</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="card stats-card h-100">
            <div class="card-body text-center p-2">
                <i class="fas fa-users fa-2x text-secondary mb-2"></i>
                <h3 class="fw-bold mb-0" id="publicCount">{{ public_count }}</h3>
                <small class="text-muted fw-bold">Public</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="card stats-card h-100">
            <div class="card-body text-center p-2">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                <h3 class="fw-bold mb-0">{{ high_severity_count }}</h3>
                <small class="text-muted fw-bold">High Severity</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="card stats-card h-100">
            <div class="card-body text-center p-2">
                <i class="fas fa-user-check fa-2x text-success mb-2"></i>
                <h3 class="fw-bold mb-0">{{ assigned_count }}</h3>
                <small class="text-muted fw-bold">Assigned</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="card stats-card h-100">
            <div class="card-body text-center p-2">
                <i class="fas fa-user-times fa-2x text-danger mb-2"></i>
                <h3 class="fw-bold mb-0">{{ unassigned_count }}</h3>
                <small class="text-muted fw-bold">Unassigned</small>
            </div>
        </div>
    </div>
</div>

<div class="card card-police mb-4">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap justify-content-between align-items-center">
            <div class="mb-2 mb-md-0">
                <small class="text-muted me-2">Filter:</small>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary active" onclick="filterByAssignment('all')">All</button>
                    <button type="button" class="btn btn-outline-success" onclick="filterByAssignment('assigned')">Assigned</button>
                    <button type="button" class="btn btn-outline-danger" onclick="filterByAssignment('unassigned')">Unassigned</button>
                </div>
            </div>
            <div class="input-group input-group-sm" style="max-width: 300px;">
                <input type="text" class="form-control" placeholder="Search incidents..." id="searchInput" onkeyup="searchIncidents()">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
            </div>
        </div>
    </div>
</div>

<div class="card card-police">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="incidentsTable">
                <thead class="table-light">
                    <tr>
                        <th>Assignment</th>
                        <th>Source</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Location</th>
                        <th>Assigned Officer</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for incident in all_incidents %}
                    <tr class="incident-row {% if not incident.is_assigned %}unassigned-incident{% else %}assigned-incident{% endif %}"
                        data-incident-id="{{ incident._id }}"
                        data-source="{{ incident.source }}"
                        data-is-assigned="{{ incident.is_assigned }}">
                        
                        <td>
                            {% if incident.is_assigned %}
                                <span class="badge bg-success"><i class="fas fa-check me-1"></i>Assigned</span>
                            {% else %}
                                <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Unassigned</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if incident.source == 'police' %}
                                <span class="badge bg-primary">Police</span>
                            {% else %}
                                <span class="badge bg-secondary">Public</span>
                            {% endif %}
                        </td>

                        <td>
                            <div class="fw-bold">{{ incident.title }}</div>
                            <small class="text-muted">{{ incident.description[:40] }}...</small>
                        </td>

                        <td>{{ incident.incident_type }}</td>

                        <td>
                            <span class="badge bg-{{ 'danger' if incident.severity == 'high' else 'warning' if incident.severity == 'medium' else 'success' }}">
                                {{ incident.severity|title }}
                            </span>
                        </td>

                        <td>
                            <span class="badge bg-{{ 'primary' if incident.status == 'active' else 'success' }}">
                                {{ incident.status|title }}
                            </span>
                        </td>

                        <td>
                            <div class="text-truncate" style="max-width: 150px;" title="{{ incident.address }}">
                                <i class="fas fa-map-marker-alt text-danger me-1"></i>{{ incident.address }}
                            </div>
                        </td>

                        <td>
                            {% if incident.assigned_officer and incident.assigned_officer != 'Unassigned' %}
                                <span class="badge bg-info text-dark">{{ incident.assigned_officer }}</span>
                            {% else %}
                                <span class="text-muted small">--</span>
                            {% endif %}
                        </td>

                        <td>
                            <small>{{ incident.created_at.strftime('%Y-%m-%d') }}<br>{{ incident.created_at.strftime('%H:%M') }}</small>
                        </td>

                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success assign-officer-btn" title="Assign Officer">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                <button class="btn btn-outline-info view-details-btn" title="Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No incidents found.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addIncidentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report New Incident</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addIncidentForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="incident_type">
                                <option>Theft</option>
                                <option>Accident</option>
                                <option>Public Disturbance</option>
                                <option>Traffic Violation</option>
                                <option>Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Severity</label>
                            <select class="form-select" name="severity">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Latitude</label>
                            <input type="number" step="any" class="form-control" name="latitude" value="14.4644">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Longitude</label>
                            <input type="number" step="any" class="form-control" name="longitude" value="75.9218">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitNewIncident()">Submit Report</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="assignOfficerModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Officer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assignIncidentId">
                <input type="hidden" id="assignIncidentSource">
                <div class="mb-3">
                    <label class="form-label">Select Officer</label>
                    <select class="form-select" id="officerSelect">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAssignment()">Assign</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Incident Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- UTILS: Fix Stuck Modal ---
    function cleanupModals() {
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style = '';
    }

    // --- SETUP LISTENERS ---
    document.addEventListener('DOMContentLoaded', function() {
        cleanupModals(); // Safety run

        const tbody = document.querySelector('tbody');
        
        // Use Event Delegation for better performance
        tbody.addEventListener('click', function(e) {
            // Assign Button
            const assignBtn = e.target.closest('.assign-officer-btn');
            if(assignBtn) {
                const row = assignBtn.closest('tr');
                openAssignModal(row.dataset.incidentId, row.dataset.source);
            }

            // Details Button
            const detailsBtn = e.target.closest('.view-details-btn');
            if(detailsBtn) {
                const row = detailsBtn.closest('tr');
                viewDetails(row.dataset.incidentId, row.dataset.source);
            }
        });
    });

    // --- FUNCTIONS ---

    function showAddIncidentModal() {
        cleanupModals();
        new bootstrap.Modal(document.getElementById('addIncidentModal')).show();
    }

    function submitNewIncident() {
        const form = document.getElementById('addIncidentForm');
        const data = Object.fromEntries(new FormData(form).entries());
        
        fetch('/api/incidents', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(() => {
            alert('Incident Reported!');
            location.reload();
        })
        .catch(err => alert('Error reporting incident'));
    }

    function openAssignModal(id, source) {
        document.getElementById('assignIncidentId').value = id;
        document.getElementById('assignIncidentSource').value = source;
        
        const select = document.getElementById('officerSelect');
        select.innerHTML = '<option>Loading...</option>';
        
        fetch('/api/police-officers')
            .then(res => res.json())
            .then(data => {
                select.innerHTML = '<option value="">Select Officer...</option>';
                data.forEach(off => {
                    const opt = document.createElement('option');
                    opt.value = off.username;
                    opt.textContent = `${off.full_name} (${off.badge_number})`;
                    select.appendChild(opt);
                });
                new bootstrap.Modal(document.getElementById('assignOfficerModal')).show();
            });
    }

    function submitAssignment() {
        const id = document.getElementById('assignIncidentId').value;
        const source = document.getElementById('assignIncidentSource').value;
        const officer = document.getElementById('officerSelect').value;

        if(!officer) return alert("Select an officer");

        fetch(`/api/incidents/${id}/assign-officer`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({assigned_officer: officer, source: source})
        })
        .then(res => res.json())
        .then(() => {
            alert("Assigned Successfully!");
            location.reload();
        });
    }

    function viewDetails(id, source) {
        fetch(`/api/incidents/${id}/details?source=${source}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('detailsContent').innerHTML = `
                    <h4>${data.title}</h4>
                    <p class="text-muted">ID: ${data.incident_id}</p>
                    <hr>
                    <div class="row">
                        <div class="col-md-6"><p><strong>Type:</strong> ${data.incident_type}</p></div>
                        <div class="col-md-6"><p><strong>Severity:</strong> ${data.severity}</p></div>
                        <div class="col-md-6"><p><strong>Status:</strong> ${data.status}</p></div>
                        <div class="col-md-6"><p><strong>Reported By:</strong> ${data.reported_by}</p></div>
                    </div>
                    <p><strong>Description:</strong><br>${data.description}</p>
                    <p><strong>Location:</strong><br>${data.address}</p>
                `;
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            });
    }

    function searchIncidents() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
        });
    }

    function filterByAssignment(type) {
        const rows = document.querySelectorAll('.incident-row');
        document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        rows.forEach(row => {
            const isAssigned = row.dataset.isAssigned === 'True';
            let show = type === 'all' || (type === 'assigned' && isAssigned) || (type === 'unassigned' && !isAssigned);
            row.style.display = show ? '' : 'none';
        });
    }
</script>
{% endblock %}